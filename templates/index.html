<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ’° Price Comparison Tool</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background: linear-gradient(135deg, #e9f5ff, #f8f9fa);
      min-height: 100vh;
      font-family: "Poppins", sans-serif;
    }

    h2 {
      font-weight: 700;
      color: #0d6efd;
    }

    .card {
      border: none;
      border-radius: 16px;
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .border-dashed {
      border: 2px dashed #cfd8dc;
      background-color: #f7f9fc;
    }

    .filter-bar input,
    .filter-bar select {
      border-radius: 8px;
      border: 1px solid #dee2e6;
    }

    table thead {
      background: #0d6efd;
      color: #fff;
    }

    table tbody tr:hover {
      background-color: #f1f5ff;
    }

    .btn-primary, .btn-success {
      border-radius: 10px;
    }

    .btn-primary:hover, .btn-success:hover {
      opacity: 0.9;
      transform: scale(1.02);
    }

    .upload-zone {
      transition: background 0.3s ease, border 0.3s ease;
    }

    .upload-zone:hover {
      border-color: #0d6efd;
      background-color: #e7f1ff;
    }
  </style>
</head>

<body class="py-5">
  <div class="container">
    <div class="text-center mb-5">
      <h2><i class="bi bi-currency-exchange me-2"></i>Price Comparison Tool</h2>
      <p class="text-muted">Compare product prices from multiple e-commerce sites effortlessly</p>
    </div>

    <div class="row g-4">
      <!-- Bulk Upload -->
      <div class="col-md-6">
        <div class="card shadow-sm p-4">
          <h5 class="mb-3"><i class="bi bi-upload me-2 text-success"></i>Bulk Upload</h5>
          <form method="POST" enctype="multipart/form-data">
            <div class="mb-3 text-center border border-dashed upload-zone p-4 rounded">
              <input type="file" name="file" class="form-control mb-2" accept=".csv,.xlsx,.xls" required>
              <small class="text-muted">
                Upload CSV or Excel file with columns:
                <b>Brand</b>, <b>Product</b>, <b>Website Name</b>, <b>OEM Number</b>, <b>ASIN Number</b>
              </small>
            </div>

            <!-- Amazon Region for Bulk Upload -->
            <div class="mb-3" id="amazonCountrySectionBulk">
              <label class="form-label fw-semibold">Amazon Region</label>
              <select name="amazon_country" class="form-select">
                <option value="amazon.com">Amazon.com (US)</option>
                <option value="amazon.co.uk">Amazon UK</option>
                <option value="amazon.in">Amazon India</option>
                <option value="amazon.ae">Amazon UAE</option>
                <option value="amazon.de">Amazon Germany</option>
                <option value="amazon.fr">Amazon France</option>
                <option value="amazon.it">Amazon Italy</option>
                <option value="amazon.es">Amazon Spain</option>
                <option value="amazon.ca">Amazon Canada</option>
                <option value="amazon.com.au">Amazon Australia</option>
                <option value="amazon.sg">Amazon Singapore</option>
                <option value="amazon.sa">Amazon Saudi Arabia</option>
                <option value="amazon.nl">Amazon Netherlands</option>
                <option value="amazon.pl">Amazon Poland</option>
                <option value="amazon.se">Amazon Sweden</option>
                <option value="amazon.co.jp">Amazon Japan</option>
                <option value="amazon.com.br">Amazon Brazil</option>
                <option value="amazon.com.mx">Amazon Mexico</option>
              </select>
              <small class="text-muted">Used when scraping Amazon or All Websites.</small>
            </div>

            <button type="submit" class="btn btn-success w-100">
              <i class="bi bi-cloud-arrow-up me-2"></i>Upload & Scrape
            </button>
          </form>
        </div>
      </div>

      <!-- Manual Entry -->
      <div class="col-md-6">
        <div class="card shadow-sm p-4">
          <h5 class="mb-3"><i class="bi bi-pencil-square me-2 text-primary"></i>Manual Entry</h5>
          <form method="POST">
            <div class="mb-3">
              <label class="form-label fw-semibold">Brand *</label>
              <input type="text" name="brand" class="form-control" placeholder="e.g., Samsung" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Product *</label>
              <input type="text" name="product" class="form-control" placeholder="e.g., Smart TV" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">OEM Number (optional)</label>
              <input type="text" name="oem_number" class="form-control" placeholder="e.g., OEM12345">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">ASIN Number (optional)</label>
              <input type="text" name="asin_number" class="form-control" placeholder="e.g., B0CXYZ123">
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Website (optional)</label>
              <select name="website" class="form-select">
                <option value="allwebsite">-- All Websites --</option>
                <option value="amazon">Amazon</option>
                <option value="flipkart">Flipkart</option>
                <option value="ebay">eBay</option>
                <option value="snapdeal">Snapdeal</option>
                <option value="amitretail">Amit Retail</option>
                <option value="noon">Noon</option>
                <option value="sharafdg">Sharaf DG</option>
                <option value="westmarine">West Marine</option>
              </select>
            </div>
            <div class="mb-3" id="amazonCountrySection" style="display: none;">
              <label class="form-label fw-semibold">Amazon Region</label>
              <select name="amazon_country" class="form-select">
                <option value="amazon.com">Amazon.com (US)</option>
                <option value="amazon.co.uk">Amazon UK</option>
                <option value="amazon.in">Amazon India</option>
                <option value="amazon.ae">Amazon UAE</option>
                <option value="amazon.de">Amazon Germany</option>
                <option value="amazon.fr">Amazon France</option>
                <option value="amazon.it">Amazon Italy</option>
                <option value="amazon.es">Amazon Spain</option>
                <option value="amazon.ca">Amazon Canada</option>
                <option value="amazon.com.au">Amazon Australia</option>
                <option value="amazon.sg">Amazon Singapore</option>
                <option value="amazon.sa">Amazon Saudi Arabia</option>
                <option value="amazon.nl">Amazon Netherlands</option>
                <option value="amazon.pl">Amazon Poland</option>
                <option value="amazon.se">Amazon Sweden</option>
                <option value="amazon.co.jp">Amazon Japan</option>
                <option value="amazon.com.br">Amazon Brazil</option>
                <option value="amazon.com.mx">Amazon Mexico</option>
              </select>
            </div>

            <script>
              const websiteSelect = document.querySelector('select[name="website"]');
              const amazonCountrySection = document.getElementById('amazonCountrySection');

              websiteSelect.addEventListener('change', () => {
                amazonCountrySection.style.display = (websiteSelect.value === 'amazon' || websiteSelect.value === '' || websiteSelect.value === 'allwebsite') ? 'block' : 'none';
              });
            </script>

            <button type="submit" class="btn btn-primary w-100">
              <i class="bi bi-search me-2"></i>Search Product
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Error -->
    {% if error %}
      <div class="alert alert-danger mt-4"><i class="bi bi-exclamation-triangle me-2"></i>{{ error }}</div>
    {% endif %}

    <!-- Results -->
    {% if results %}
      <div class="card shadow-sm mt-5 p-4">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="bi bi-table me-2 text-primary"></i>Scraped Results ({{ results|length }} Products)</h5>
          <button class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
            <i class="bi bi-download me-1"></i>Export CSV
          </button>
        </div>

        <!-- Filters -->
        <div class="row g-2 mb-3 filter-bar">
          <div class="col-md-4">
            <input type="text" id="filterBrand" class="form-control" placeholder="Filter by Brand or Product..." onkeyup="filterTable()">
          </div>
          <div class="col-md-4">
            <select id="filterWebsite" class="form-select" onchange="filterTable()">
              <option value="">All Websites</option>
              <option value="Amazon">Amazon</option>
              <option value="Flipkart">Flipkart</option>
              <option value="eBay">eBay</option>
              <option value="Snapdeal">Snapdeal</option>
              <option value="amitretail">Amit Retail</option>
              <option value="noon">Noon</option>
              <option value="sharafdg">Sharaf DG</option>
              <option value="westmarine">West Marine</option>
            </select>
          </div>
          <div class="col-md-4">
            <input type="number" id="filterPrice" class="form-control" placeholder="Max Price..." onkeyup="filterTable()">
          </div>
        </div>

        <div class="table-responsive">
          <table id="resultsTable" class="table table-striped table-bordered align-middle text-center">
            <thead>
              <tr>
                <th>Brand</th>
                <th>Product</th>
                <th>OEM Number</th>
                <th>ASIN Number</th>
                <th>Website</th>
                <th>Product Name</th>
                <th>Currency</th>
                <th>Price</th>
                <th>Seller Rating</th>
                <th>Date Scraped</th>
                <th>Source URL</th>
              </tr>
            </thead>
            <tbody>
              {% for item in results %}
                <tr>
                  <td>{{ item.get("BRAND", "") }}</td>
                  <td>{{ item.get("PRODUCT", "") }}</td>
                  <td>{{ item.get("OEM NUMBER", "") }}</td>
                  <td>{{ item.get("ASIN NUMBER", "") }}</td>
                  <td>{{ item.WEBSITE }}</td>
                  <td class="text-start">{{ item["PRODUCT NAME"] }}</td>
                  <td>{{ item.CURRENCY }}</td>
                  <td>{{ item.PRICE }}</td>
                  <td>{{ item["SELLER RATING"] }}</td>
                  <td>{{ item["DATE SCRAPED"] }}</td>
                  <td><a href="{{ item['SOURCE URL'] }}" target="_blank" class="text-decoration-none text-primary">View</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  </div>

  <script>
    function filterTable() {
      let brandInput = document.getElementById("filterBrand").value.toLowerCase();
      let websiteInput = document.getElementById("filterWebsite").value.toLowerCase();
      let priceInput = parseFloat(document.getElementById("filterPrice").value);
      let rows = document.querySelectorAll("#resultsTable tbody tr");

      rows.forEach(row => {
        let website = row.cells[4].innerText.toLowerCase();
        let brandOrProduct = (row.cells[0].innerText + " " + row.cells[1].innerText).toLowerCase();
        let price = parseFloat(row.cells[7].innerText);
        let visible = true;

        if (brandInput && !brandOrProduct.includes(brandInput)) visible = false;
        if (websiteInput && website !== websiteInput) visible = false;
        if (!isNaN(priceInput) && price > priceInput) visible = false;

        row.style.display = visible ? "" : "none";
      });
    }

    function exportToCSV() {
      let table = document.getElementById("resultsTable");
      let rows = table.querySelectorAll("tr");
      let csv = [];

      rows.forEach(row => {
        let cols = row.querySelectorAll("th, td");
        let data = [];
        cols.forEach(col => data.push('"' + col.innerText.replace(/"/g, '""') + '"'));
        csv.push(data.join(","));
      });

      let blob = new Blob([csv.join("\n")], { type: "text/csv" });
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "price_comparison_results.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  </script>
</body>
</html>
